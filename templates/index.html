<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIL Report Generator - Terna</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-container">
        <div class="app-header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='logo/terna_logo.png') }}" alt="Terna Logo">
                </div>
                <div class="header-text">
                    <h1>DIGIL Report Generator</h1>
                    <p>Sistema di generazione report per dispositivi DIGIL</p>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <form id="reportForm" method="POST">
                <div class="form-grid">
                    <!-- Sezione Configurazione Device -->
                    <div class="form-section">
                        <h3>📡 Configurazione Device</h3>
                        
                        <div class="form-group">
                            <label for="num_sensors">Numero Sensori *</label>
                            <select class="form-select" id="num_sensors" name="num_sensors" required>
                                <option value="">Seleziona...</option>
                                <option value="3">3 Sensori</option>
                                <option value="6">6 Sensori</option>
                                <option value="12">12 Sensori</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="vendor">Vendor *</label>
                            <select class="form-select" id="vendor" name="vendor" required>
                                <option value="">Seleziona...</option>
                                <option value="MII">MII</option>
                                <option value="Indra/Olivetti">Indra/Olivetti</option>
                                <option value="Sirtiv2">Sirtiv2</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="device_id">Device ID *</label>
                            <input type="text" class="form-control" id="device_id" name="device_id" 
                                   placeholder="es. 1:1:2:16:22:DIGIL_MRN_0299" required>
                            <div class="form-text">Formato: 1:1:2:16:22:DIGIL_XXX_YYYY</div>
                        </div>
                    </div>
                    
                    <!-- Sezione Periodo Test -->
                    <div class="form-section">
                        <h3>📅 Periodo Test</h3>
                        
                        <div class="form-group">
                            <label>Data e Ora Inizio *</label>
                            <div class="datetime-grid">
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                <input type="time" class="form-control" id="start_time" name="start_time" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Data e Ora Fine *</label>
                            <div class="datetime-grid">
                                <input type="date" class="form-control" id="end_date" name="end_date" required>
                                <input type="time" class="form-control" id="end_time" name="end_time" required>
                            </div>
                        </div>
                        
                        <div class="form-text">
                            * La data di fine viene auto-compilata quando inserisci la data di inizio
                        </div>
                    </div>

                    <!-- Sezione Opzioni Invio -->
                    <div class="form-section">
                        <h3>📧 Opzioni Invio Email</h3>

                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="send_email" name="send_email" style="width: auto;">
                                <label for="send_email" style="margin: 0; cursor: pointer;">
                                    Invia report via email dopo la generazione
                                </label>
                            </div>
                        </div>

                        <div id="email_options" style="display: none;">
                            <div class="alert alert-info" style="margin: 15px 0;">
                                <small>Il report verrà inviato agli indirizzi configurati per il vendor selezionato.</small>
                            </div>

                            <div class="form-group">
                                <label for="custom_email">Email personalizzata (opzionale)</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="custom_email" 
                                       name="custom_email" 
                                       placeholder="Lascia vuoto per usare gli indirizzi predefiniti">
                                <div class="form-text">
                                    Se specificata, il report verrà inviato SOLO a questa email
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ui_location">UI Località *</label>
                        <select class="form-select" id="ui_location" name="ui_location" required>
                            <option value="">Seleziona...</option>
                            <option value="Abruzzo Molise">Abruzzo Molise</option>
                            <option value="Bari">Bari</option>
                            <option value="Bologna">Bologna</option>
                            <option value="Brescia">Brescia</option>
                            <option value="Brindisi">Brindisi</option>
                            <option value="Brugherio">Brugherio</option>
                            <option value="Catania">Catania</option>
                            <option value="Chiuro">Chiuro</option>
                            <option value="Cislago">Cislago</option>
                            <option value="Codrongianos">Codrongianos</option>
                            <option value="Dugale">Dugale</option>
                            <option value="Feroleto">Feroleto</option>
                            <option value="Firenze">Firenze</option>
                            <option value="Frattamaggiore">Frattamaggiore</option>
                            <option value="Friuli Venezia Giulia">Friuli Venezia Giulia</option>
                            <option value="Genova">Genova</option>
                            <option value="Gorlago">Gorlago</option>
                            <option value="Lazio">Lazio</option>
                            <option value="Lazio Centro Sud">Lazio Centro Sud</option>
                            <option value="Lazio Nord">Lazio Nord</option>
                            <option value="Maddaloni">Maddaloni</option>
                            <option value="Marche">Marche</option>
                            <option value="Novara">Novara</option>
                            <option value="Palermo">Palermo</option>
                            <option value="Parma">Parma</option>
                            <option value="Pont Saint Martin">Pont Saint Martin</option>
                            <option value="Rotonda">Rotonda</option>
                            <option value="Suvereto">Suvereto</option>
                            <option value="Torino">Torino</option>
                            <option value="Trentino Alto Adige">Trentino Alto Adige</option>
                            <option value="Villasor">Villasor</option>
                            <option value="Vittorio Veneto">Vittorio Veneto</option>
                        </select>
                        <div class="form-text">Seleziona l'UI dove si trova il dispositivo (necessaria per test metriche)</div>
                    </div>
                    
                    <!-- Colonna destra: Switch Downlink -->
                    <div style="flex: 0 0 auto; margin-top: 25px;">
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e1e8ed;">
                            <label class="switch-label" style="margin: 0; white-space: nowrap; font-weight: 500;">
                                Scenario Downlink:
                            </label>
                            <div class="form-check form-switch" style="margin: 0;">
                                <input class="form-check-input" type="checkbox" id="enable_downlink" name="enable_downlink" checked 
                                    style="cursor: pointer; width: 50px; height: 25px; margin: 0;">
                                <label class="form-check-label" for="enable_downlink" id="downlink_status" 
                                    style="margin-left: 10px; font-weight: bold; color: #28a745; margin-bottom: 0;">
                                    Abilitato
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="button-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 30px;">
            <!-- Prima riga: Test -->
            <button type="button" class="btn btn-info" onclick="runDownlinkTest()">
                🧪 Test Downlink
            </button>
            <button type="button" class="btn btn-success" onclick="runMetricsTest()">
                📊 Test Metriche
            </button>
            <button type="button" class="btn btn-danger" onclick="runAlarmTest()">
                🚨 Test Allarmi
            </button>
            
            <!-- Seconda riga: Azioni principali -->
            <button type="button" class="btn btn-secondary" onclick="showPreview()">
                👁️ Anteprima Report
            </button>
            <button type="submit" form="reportForm" class="btn btn-primary" formaction="/generate">
                💾 Genera e Salva Report
            </button>
            <a href="/reset" class="btn btn-warning" style="display: flex; align-items: center; justify-content: center;">
                🔄 Reset Dispositivo
            </a>
            
            <!-- Terza riga: Nuovo bottone centrato -->
            <div style="grid-column: span 3;">
                <button type="button" class="btn btn-live" onclick="openLiveMonitoring()" 
                        style="width: 50%; margin: 0 auto; display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    📡 Monitoraggio Live
                </button>
            </div>

        </div>
        
        <!-- Area risultati test -->
        <div id="testResults" style="display:none; margin: 20px 40px;">
            <!-- I risultati del test verranno mostrati qui -->
        </div>
        
        <div id="preview" style="display:none;">
            <!-- Preview content will be loaded here -->
        </div>
        
        <div class="footer">
            <p>DIGIL Report Generator v1.1</p>
        </div>
    </div>

    <script>    
        function runDownlinkTest() {
            const deviceId = document.getElementById('device_id').value;
            
            if (!deviceId) {
                alert('Inserisci prima il Device ID');
                return;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>🔄 Test Downlink in corso...</h5>
                    <div class="spinner"></div>
                    <p>Attendere, il test richiede circa 60 secondi</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            
            fetch('/test_downlink', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>✅ Test Downlink Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Durata:</strong> ${data.duration ? data.duration.toFixed(1) : 'N/A'} secondi</p>
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">📋 Dettagli steps</summary>
                                <ul style="margin-top: 10px; list-style: none; padding-left: 0;">
                                    ${data.steps ? data.steps.map(s => `
                                        <li style="padding: 5px 0; border-bottom: 1px solid #c3e6cb;">
                                            <span style="color: #6c757d; font-size: 0.9em;">${s.timestamp}</span> - 
                                            <strong>${s.step}:</strong> 
                                            ${s.success ? 
                                                '<span style="color: #28a745;">✓</span>' : 
                                                '<span style="color: #dc3545;">✗</span>'} 
                                            ${s.message}
                                        </li>
                                    `).join('') : '<li>Nessun dettaglio disponibile</li>'}
                                </ul>
                            </details>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-danger">
                            <h5>❌ Test Downlink Fallito</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Errore:</strong> ${data.error || 'Errore sconosciuto'}</p>
                            ${data.steps && data.steps.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📋 Dettagli steps</summary>
                                    <ul style="margin-top: 10px; list-style: none; padding-left: 0;">
                                        ${data.steps.map(s => `
                                            <li style="padding: 5px 0; border-bottom: 1px solid #f5c6cb;">
                                                <span style="color: #6c757d; font-size: 0.9em;">${s.timestamp}</span> - 
                                                <strong>${s.step}:</strong> 
                                                ${s.success ? 
                                                    '<span style="color: #28a745;">✓</span>' : 
                                                    '<span style="color: #dc3545;">✗</span>'} 
                                                ${s.message}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function runMetricsTest() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;

            if (!deviceId || !numSensors) {
                alert('Inserisci Device ID e Numero Sensori');
                return;
            }

            // Chiedi il range temporale
            const timeRange = prompt('Controlla metriche degli ultimi X minuti:', '5');
            if (!timeRange) return;

            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>🔄 Test Metriche in Range in corso...</h5>
                    <div class="spinner"></div>
                    <p>Recupero metriche degli ultimi ${timeRange} minuti...</p>
                    <p>UI: ${uiLocation}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('num_sensors', numSensors);
            formData.append('time_range', timeRange);
            formData.append('ui_location', uiLocation);
            
            fetch('/test_metrics', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>✅ Test Metriche Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Metriche trovate:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Letture totali:</strong> ${data.total_readings || 'N/A'}</p>
                            <p><strong>Prima lettura:</strong> ${data.first_reading || 'N/A'}</p>
                            <p><strong>Ultima lettura:</strong> ${data.last_reading || 'N/A'}</p>
                            
                            ${data.metrics_by_category ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">🌤️ Stazione Meteo (${data.metrics_by_category.weather.found.length}/5)</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.metrics_by_category.weather.found.length > 0 ? 
                                            `<li><strong>Trovate:</strong><br>${data.metrics_by_category.weather.found.map(m => `• ${m}`).join('<br>')}</li>` : 
                                            '<li>Nessuna metrica trovata</li>'}
                                        ${data.metrics_by_category.weather.missing.length > 0 ? 
                                            `<li style="margin-top: 10px;"><strong>Mancanti:</strong><br>${data.metrics_by_category.weather.missing.map(m => `• ${m}`).join('<br>')}</li>` : ''}
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📦 Smart Junction Box (${data.metrics_by_category.junction_box.found.length}/5)</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.metrics_by_category.junction_box.found.length > 0 ? 
                                            `<li><strong>Trovate:</strong><br>${data.metrics_by_category.junction_box.found.map(m => `• ${m}`).join('<br>')}</li>` : 
                                            '<li>Nessuna metrica trovata</li>'}
                                        ${data.metrics_by_category.junction_box.missing.length > 0 ? 
                                            `<li style="margin-top: 10px;"><strong>Mancanti:</strong><br>${data.metrics_by_category.junction_box.missing.map(m => `• ${m}`).join('<br>')}</li>` : ''}
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">⚡ Sensori di Tiro (${data.metrics_by_category.load.found.length}/${numSensors == '3' ? 3 : numSensors == '6' ? 6 : 12})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.metrics_by_category.load.found.length > 0 ? 
                                            `<li><strong>Trovate:</strong><br>${data.metrics_by_category.load.found.map(m => `• ${m}`).join('<br>')}</li>` : 
                                            '<li>Nessuna metrica trovata</li>'}
                                        ${data.metrics_by_category.load.missing.length > 0 ? 
                                            `<li style="margin-top: 10px;"><strong>Mancanti:</strong><br>${data.metrics_by_category.load.missing.map(m => `• ${m}`).join('<br>')}</li>` : ''}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                    ${data.details.map(d => `
                                        <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: #dc3545;' : 'color: #28a745;'}">
                                            <span style="color: #6c757d;">${d.timestamp}</span> - ${d.message}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <h5>⚠️ Test Metriche - METRICHE MANCANTI</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Metriche trovate:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Metriche mancanti:</strong> ${data.missing_metrics ? data.missing_metrics.join(', ') : 'N/A'}</p>
                            
                            ${data.metrics_by_category ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">🌤️ Stazione Meteo</summary>
                                    <ul style="margin-top: 10px;">
                                        <li><strong>Trovate:</strong> ${data.metrics_by_category.weather.found.join(', ') || 'Nessuna'}</li>
                                        <li><strong>Mancanti:</strong> ${data.metrics_by_category.weather.missing.join(', ') || 'Nessuna'}</li>
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📦 Smart Junction Box</summary>
                                    <ul style="margin-top: 10px;">
                                        <li><strong>Trovate:</strong> ${data.metrics_by_category.junction_box.found.join(', ') || 'Nessuna'}</li>
                                        <li><strong>Mancanti:</strong> ${data.metrics_by_category.junction_box.missing.join(', ') || 'Nessuna'}</li>
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">⚡ Sensori di Tiro</summary>
                                    <ul style="margin-top: 10px;">
                                        <li><strong>Trovate:</strong> ${data.metrics_by_category.load.found.join(', ') || 'Nessuna'}</li>
                                        <li><strong>Mancanti:</strong> ${data.metrics_by_category.load.missing.join(', ') || 'Nessuna'}</li>
                                    </ul>
                                </details>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                    ${data.details ? data.details.map(d => `
                                        <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: red;' : ''}">
                                            ${d.timestamp} - ${d.message}
                                        </div>
                                    `).join('') : 'Nessun dettaglio'}
                                </div>
                            </details>
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function runAlarmTest() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;
        
            if (!deviceId || !numSensors || !uiLocation) {
                alert('Inserisci Device ID, Numero Sensori e UI');
                return;
            }
        
            // Mappatura per nomi friendly degli allarmi
            const alarmNames = {
                'EGM_OUT_SENS_23_VAR_32': 'TC_F12A_L1',
                'EGM_OUT_SENS_23_VAR_33': 'TC_F12A_L2',
                'EGM_OUT_SENS_23_VAR_34': 'TC_F12B_L1',
                'EGM_OUT_SENS_23_VAR_35': 'TC_F12B_L2',
                'EGM_OUT_SENS_23_VAR_36': 'TC_F4A_L1',
                'EGM_OUT_SENS_23_VAR_37': 'TC_F4A_L2',
                'EGM_OUT_SENS_23_VAR_38': 'TC_F4B_L1',
                'EGM_OUT_SENS_23_VAR_39': 'TC_F4B_L2',
                'EGM_OUT_SENS_23_VAR_40': 'TC_F8A_L1',
                'EGM_OUT_SENS_23_VAR_41': 'TC_F8A_L2',
                'EGM_OUT_SENS_23_VAR_42': 'TC_F8B_L1',
                'EGM_OUT_SENS_23_VAR_43': 'TC_F8B_L2',
                'EGM_OUT_SENS_23_VAR_30': 'Inc_X',
                'EGM_OUT_SENS_23_VAR_31': 'Inc_Y'
            };
        
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>🚨 Test Allarme Metriche in corso...</h5>
                    <div class="spinner"></div>
                    <p>Recupero ultimi allarmi disponibili...</p>
                    <p>UI: ${uiLocation}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('num_sensors', numSensors);
            formData.append('ui_location', uiLocation);
            
            fetch('/test_alarm', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())

            .then(data => {
                console.log('Dati ricevuti dal test allarmi:', data);
                
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>✅ Test Allarmi Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Allarmi trovati:</strong> ${data.total_found}/${data.total_expected}</p>
                            <br>
                            <p>Response</p>
                            
                            ${data.found_alarms && data.found_alarms.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">✅ Allarmi verificati (${data.found_alarms.length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.found_alarms.map(alarm => {
                                            const friendlyName = alarmNames[alarm] || alarm;
                                            const value = data.alarm_values ? data.alarm_values[alarm] : 'N/A';
                                            return `<li><strong>${alarm} - ${friendlyName}:</strong> ${value}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.other_alarms && Object.keys(data.other_alarms).length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">ℹ️ Altri allarmi trovati (${Object.keys(data.other_alarms).length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${Object.entries(data.other_alarms).map(([key, val]) => {
                                            const friendlyName = alarmNames[key] || key;
                                            return `<li><strong>${key} - ${friendlyName}:</strong> ${val}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.details && data.details.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                    <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                        ${data.details.map(d => `
                                            <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: #dc3545;' : 'color: #28a745;'}">
                                                <span style="color: #6c757d;">${d.timestamp}</span> - ${d.message}
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <h5>⚠️ Test Allarmi - ALLARMI MANCANTI</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Allarmi trovati:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Allarmi mancanti:</strong> ${data.missing_alarms ? 
                                data.missing_alarms.map(alarm => {
                                    const friendlyName = alarmNames[alarm] || alarm;
                                    return `${alarm} - ${friendlyName}`;
                                }).join(', ') : 
                                'N/A'}</p>
                            <br>
                            <p>Response</p>
                            
                            ${data.found_alarms && data.found_alarms.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">✅ Allarmi trovati (${data.found_alarms.length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.found_alarms.map(alarm => {
                                            const friendlyName = alarmNames[alarm] || alarm;
                                            const value = data.alarm_values ? data.alarm_values[alarm] : 'N/A';
                                            return `<li><strong>${alarm} - ${friendlyName}:</strong> ${value}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.other_alarms && Object.keys(data.other_alarms).length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">ℹ️ Altri allarmi trovati (${Object.keys(data.other_alarms).length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${Object.entries(data.other_alarms).map(([key, val]) => {
                                            const friendlyName = alarmNames[key] || key;
                                            return `<li><strong>${key} - ${friendlyName}:</strong> ${val}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.details && data.details.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                    <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                        ${data.details.map(d => `
                                            <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: #dc3545;' : 'color: #28a745;'}">
                                                <span style="color: #6c757d;">${d.timestamp}</span> - ${d.message}
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function openLiveMonitoring() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;

            if (!deviceId || !numSensors || !uiLocation) {
                alert('⚠️ Compilare prima i campi:\n\n• Device ID\n• Numero Sensori\n• UI Località');
                return;
            }

            // Apri pagina di monitoraggio con parametri
            const params = new URLSearchParams({
                device_id: deviceId,
                num_sensors: numSensors,
                ui: uiLocation,
                timeout: 120, // Timeout di 60 minuti
                mode: 'unified' // Indica modalità unificata per metriche + allarmi
            });

            window.open(`/monitoring?${params}`, '_blank');
        }

        // Auto-fill end date quando cambia start date
        document.getElementById('start_date').addEventListener('change', function() {
            const endDate = document.getElementById('end_date');
            if (!endDate.value) {
                endDate.value = this.value;
            }
        });

        // Auto-fill end time quando cambia start time  
        document.getElementById('start_time').addEventListener('change', function() {
            const endTime = document.getElementById('end_time');
            if (!endTime.value) {
                endTime.value = this.value;
            }
        });

        // Toggle email options
        document.getElementById('send_email').addEventListener('change', function() {
            const emailOptions = document.getElementById('email_options');
            emailOptions.style.display = this.checked ? 'block' : 'none';
        });
        
        // Toggle label per Downlink
        document.getElementById('enable_downlink').addEventListener('change', function() {
            const statusLabel = document.getElementById('downlink_status');
            if (this.checked) {
                statusLabel.textContent = 'Abilitato';
                statusLabel.style.color = '#28a745';
            } else {
                statusLabel.textContent = 'Disabilitato';
                statusLabel.style.color = '#dc3545';
            }
        });

        function validateDateTime() {
            const startDate = document.getElementById('start_date').value;
            const startTime = document.getElementById('start_time').value;
            const endDate = document.getElementById('end_date').value;
            const endTime = document.getElementById('end_time').value;
            
            // Controlla che tutti i campi siano compilati
            if (!startDate || !startTime || !endDate || !endTime) {
                return {
                    valid: false,
                    message: 'Compila tutti i campi di data e ora'
                };
            }
            
            // Crea oggetti Date per il confronto
            const startDateTime = new Date(`${startDate}T${startTime}:00`);
            const endDateTime = new Date(`${endDate}T${endTime}:00`);
            
            // Verifica che la data/ora di fine sia successiva a quella di inizio
            if (endDateTime <= startDateTime) {
                return {
                    valid: false,
                    message: 'La data/ora di fine deve essere successiva a quella di inizio'
                };
            }
            
            // Verifica che la durata non sia eccessiva (es. max 7 giorni)
            const diffHours = (endDateTime - startDateTime) / (1000 * 60 * 60);
            if (diffHours > 168) { // 7 giorni = 168 ore
                return {
                    valid: false,
                    message: 'La durata del test non può superare i 7 giorni'
                };
            }
            
            return {
                valid: true,
                message: 'Date valide'
            };
        }

        // Funzione per mostrare errori di validazione
        function showValidationError(message) {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = `
                <div class="alert alert-danger">
                    <h5>❌ Errore Validazione</h5>
                    <p>${message}</p>
                </div>
            `;
            testResults.style.display = 'block';
            
            // Scorri verso l'errore
            testResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showPreview() {
            // Validazione data/ora
            const validation = validateDateTime();
            if (!validation.valid) {
                showValidationError(validation.message);
                return;
            }
            
            const form = document.getElementById('reportForm');
            const formData = new FormData(form);
            
            const downlinkCheckbox = document.getElementById('enable_downlink');
            if (downlinkCheckbox) {
                formData.delete('enable_downlink');
                if (downlinkCheckbox.checked) {
                    formData.append('enable_downlink', 'on');
                }
            }
            
            const previewDiv = document.getElementById('preview');
            previewDiv.innerHTML = '<div class="alert alert-info"><span class="spinner"></span> Caricamento anteprima...</div>';
            previewDiv.style.display = 'block';
            
            fetch('/preview', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                previewDiv.innerHTML = html;
            })
            .catch(error => {
                previewDiv.innerHTML = '<div class="alert alert-danger">Errore nel caricamento dell\'anteprima</div>';
            });
        }

        // Validazione al submit del form
        document.addEventListener('DOMContentLoaded', function() {
            const reportForm = document.getElementById('reportForm');
            
            reportForm.addEventListener('submit', function(e) {
                console.log('Form submit intercepted for validation');
                
                // Validazione data/ora prima del submit
                const validation = validateDateTime();
                if (!validation.valid) {
                    console.log('Validation failed:', validation.message);
                    e.preventDefault(); // Impedisce il submit
                    showValidationError(validation.message);
                    return false;
                }
                
                console.log('Validation passed, allowing form submit');
            });
            
            // Validazione in tempo reale quando cambiano i campi
            const dateTimeFields = ['start_date', 'start_time', 'end_date', 'end_time'];
            dateTimeFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function() {
                        // Nascondi eventuali errori precedenti dopo 2 secondi
                        setTimeout(() => {
                            const testResults = document.getElementById('testResults');
                            if (testResults.style.display !== 'none') {
                                const alertDanger = testResults.querySelector('.alert-danger');
                                if (alertDanger && alertDanger.textContent.includes('Errore Validazione')) {
                                    testResults.style.display = 'none';
                                }
                            }
                        }, 2000);
                    });
                }
            });
        });        
    </script>
</body>
</html>