<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIL Report Generator - Terna</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-container">
        <div class="app-header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='logo/terna_logo.png') }}" alt="Terna Logo">
                </div>
                <div class="header-text">
                    <h1>DIGIL Report Generator</h1>
                    <p>Sistema di generazione report per dispositivi DIGIL</p>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <form id="reportForm" method="POST">
                <div class="form-grid">
                    <!-- Sezione Configurazione Device -->
                    <div class="form-section">
                        <h3>📡 Configurazione Device</h3>
                        
                        <div class="form-group">
                            <label for="num_sensors">Numero Sensori *</label>
                            <select class="form-select" id="num_sensors" name="num_sensors" required>
                                <option value="">Seleziona...</option>
                                <option value="3">3 Sensori</option>
                                <option value="6">6 Sensori</option>
                                <option value="12">12 Sensori</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="vendor">Vendor *</label>
                            <select class="form-select" id="vendor" name="vendor" required>
                                <option value="">Seleziona...</option>
                                <option value="MII">MII</option>
                                <option value="Indra/Olivetti">Indra/Olivetti</option>
                                <option value="Sirtiv2">Sirtiv2</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="device_id">Device ID *</label>
                            <input type="text" class="form-control" id="device_id" name="device_id" 
                                   placeholder="es. 1:1:2:16:22:DIGIL_MRN_0299" required>
                            <div class="form-text">Formato: 1:1:2:16:22:DIGIL_XXX_YYYY</div>
                        </div>
                    </div>
                    
                    <!-- Sezione Periodo Test -->
                    <div class="form-section">
                        <h3>📅 Periodo Test</h3>
                        
                        <div class="form-group">
                            <label>Data e Ora Inizio *</label>
                            <div class="datetime-grid">
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                <input type="time" class="form-control" id="start_time" name="start_time" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Data e Ora Fine *</label>
                            <div class="datetime-grid">
                                <input type="date" class="form-control" id="end_date" name="end_date" required>
                                <input type="time" class="form-control" id="end_time" name="end_time" required>
                            </div>
                        </div>
                        
                        <div class="form-text">
                            * La data di fine viene auto-compilata quando inserisci la data di inizio
                        </div>
                    </div>

                    <!-- Sezione Opzioni Invio -->
                    <div class="form-section">
                        <h3>📧 Opzioni Invio Email</h3>

                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="send_email" name="send_email" style="width: auto;">
                                <label for="send_email" style="margin: 0; cursor: pointer;">
                                    Invia report via email dopo la generazione
                                </label>
                            </div>
                        </div>

                        <div id="email_options" style="display: none;">
                            <div class="alert alert-info" style="margin: 15px 0;">
                                <small>Il report verrà inviato agli indirizzi configurati per il vendor selezionato.</small>
                            </div>

                            <div class="form-group">
                                <label for="custom_email">Email personalizzata (opzionale)</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="custom_email" 
                                       name="custom_email" 
                                       placeholder="Lascia vuoto per usare gli indirizzi predefiniti">
                                <div class="form-text">
                                    Se specificata, il report verrà inviato SOLO a questa email
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section" style="grid-column: 1 / -1;">
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: start;">
                            <!-- Colonna sinistra: UI Località -->
                            <div>
                                <div class="form-group">
                                    <label for="ui_location">UI Località *</label>
                                    <select class="form-select" id="ui_location" name="ui_location" required>
                                        <option value="">Seleziona...</option>
                                        <option value="Abruzzo Molise">Abruzzo Molise</option>
                                        <option value="Bari">Bari</option>
                                        <option value="Bologna">Bologna</option>
                                        <option value="Brescia">Brescia</option>
                                        <option value="Brindisi">Brindisi</option>
                                        <option value="Brugherio">Brugherio</option>
                                        <option value="Catania">Catania</option>
                                        <option value="Chiuro">Chiuro</option>
                                        <option value="Cislago">Cislago</option>
                                        <option value="Codrongianos">Codrongianos</option>
                                        <option value="Dugale">Dugale</option>
                                        <option value="Feroleto">Feroleto</option>
                                        <option value="Firenze">Firenze</option>
                                        <option value="Frattamaggiore">Frattamaggiore</option>
                                        <option value="Friuli Venezia Giulia">Friuli Venezia Giulia</option>
                                        <option value="Genova">Genova</option>
                                        <option value="Gorlago">Gorlago</option>
                                        <option value="Lazio">Lazio</option>
                                        <option value="Lazio Centro Sud">Lazio Centro Sud</option>
                                        <option value="Lazio Nord">Lazio Nord</option>
                                        <option value="Maddaloni">Maddaloni</option>
                                        <option value="Marche">Marche</option>
                                        <option value="Novara">Novara</option>
                                        <option value="Palermo">Palermo</option>
                                        <option value="Parma">Parma</option>
                                        <option value="Pont Saint Martin">Pont Saint Martin</option>
                                        <option value="Rotonda">Rotonda</option>
                                        <option value="Suvereto">Suvereto</option>
                                        <option value="Torino">Torino</option>
                                        <option value="Trentino Alto Adige">Trentino Alto Adige</option>
                                        <option value="Villasor">Villasor</option>
                                        <option value="Vittorio Veneto">Vittorio Veneto</option>
                                    </select>
                                    <div class="form-text">Seleziona l'UI dove si trova il dispositivo (necessaria per test metriche)</div>
                                </div>
                            </div>
                            
                            <!-- Colonna destra: Switch centrati -->
                            <div style="display: flex; justify-content: center; gap: 30px; align-items: center; height: 100%;">
                                <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e1e8ed;">
                                    <label class="switch-label" style="margin: 0; white-space: nowrap; font-weight: 500;">
                                        Scenario Downlink:
                                    </label>
                                    <div class="form-check form-switch" style="margin: 0;">
                                        <input class="form-check-input" type="checkbox" id="enable_downlink" name="enable_downlink" 
                                            style="cursor: pointer; width: 50px; height: 25px; margin: 0;">
                                        <label class="form-check-label" for="enable_downlink" id="downlink_status" 
                                            style="margin-left: 10px; font-weight: bold; color: #dc3545; margin-bottom: 0;">
                                            Disabilitato
                                        </label>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e1e8ed;">
                                    <label class="switch-label" style="margin: 0; white-space: nowrap; font-weight: 500;">
                                        Scenario Allarme:
                                    </label>
                                    <div class="form-check form-switch" style="margin: 0;">
                                        <input class="form-check-input" type="checkbox" id="enable_allarme" name="enable_allarme" checked 
                                            style="cursor: pointer; width: 50px; height: 25px; margin: 0;">
                                        <label class="form-check-label" for="enable_allarme" id="allarme_status" 
                                            style="margin-left: 10px; font-weight: bold; color: #28a745; margin-bottom: 0;">
                                            Abilitato
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="button-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 30px;">
            <!-- Prima riga: Test -->
            <button type="button" class="btn btn-info" onclick="runDownlinkTest()">
                🧪 Test Downlink
            </button>
            <button type="button" class="btn btn-success" onclick="runMetricsTest()">
                📊 Test Metriche
            </button>
            <button type="button" class="btn btn-danger" onclick="runAlarmTest()">
                🚨 Test Allarmi
            </button>
            
            <!-- Seconda riga: Azioni principali -->
            <button type="button" class="btn btn-secondary" onclick="showPreview()">
                👁️ Anteprima Report
            </button>
            <button type="submit" form="reportForm" class="btn btn-primary" formaction="/generate">
                💾 Genera e Salva Report
            </button>
            <a href="/reset" class="btn btn-warning" style="display: flex; align-items: center; justify-content: center;">
                🔄 Reset Dispositivo
            </a>
            
            <!-- Terza riga: Nuovo bottone centrato -->
            <div style="grid-column: span 3;">
                <button type="button" class="btn btn-live" onclick="openLiveMonitoring()" 
                        style="width: 50%; margin: 0 auto; display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    📡 Monitoraggio Live
                </button>
            </div>

        </div>
        
        <!-- Area risultati test -->
        <div id="testResults" style="display:none; margin: 20px 40px;">
            <!-- I risultati del test verranno mostrati qui -->
        </div>
        
        <div id="preview" style="display:none;">
            <!-- Preview content will be loaded here -->
        </div>

        <div style="margin: 20px 40px;">
            <div style="text-align: center;">
                <button type="button" 
                        class="btn btn-secondary" 
                        onclick="toggleAnagrafica()"
                        id="toggleAnagraficaBtn"
                        style="width: 300px; margin: 0 auto;">
                    📂 Gestione Anagrafica ▼
                </button>
            </div>
            
            <div id="anagraficaSection" 
                style="display: none; 
                        margin-top: 20px; 
                        padding: 25px;
                        background: #f0f8ff; 
                        border: 2px dashed #004A93;
                        border-radius: 10px;
                        animation: slideDown 0.3s ease-out;">
                
                <h3 style="margin-top: 0; color: #004A93;">📂 Gestione Anagrafica Dispositivi</h3>
                
                <div id="anagraficaStatus" style="margin-bottom: 15px;">
                    <div class="alert alert-info" style="margin: 0;">
                        <strong>Stato:</strong> <span id="csvStatus">Nessuna anagrafica caricata</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="csvFile">Carica file anagrafica (digil_anagrafica_data_result.csv)</label>
                    <input type="file" 
                        class="form-control" 
                        id="csvFile" 
                        accept=".csv"
                        style="padding: 10px;">
                    <div class="form-text">
                        Carica il CSV con l'anagrafica completa dei dispositivi per abilitare l'auto-compilazione di Numero Sensori e UI
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" class="btn btn-info" onclick="loadCSV()" style="flex: 1;">
                        📥 Carica Anagrafica
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearAnagrafica()" style="flex: 1;">
                        🗑️ Cancella Anagrafica
                    </button>
                </div>
                
                <div id="anagraficaStats" style="display: none; margin-top: 15px;">
                    <div class="alert alert-success">
                        <strong>✅ Anagrafica caricata con successo!</strong><br>
                        <span id="statsInfo"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>DIGIL Report Generator v1.2</p>
        </div>
    </div>

    <script>    
        function runDownlinkTest() {
            const deviceId = document.getElementById('device_id').value;
            
            if (!deviceId) {
                alert('Inserisci prima il Device ID');
                return;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>🔄 Test Downlink in corso...</h5>
                    <div class="spinner"></div>
                    <p>Attendere, il test richiede circa 60 secondi</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            
            fetch('/test_downlink', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>✅ Test Downlink Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Durata:</strong> ${data.duration ? data.duration.toFixed(1) : 'N/A'} secondi</p>
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">📋 Dettagli steps</summary>
                                <ul style="margin-top: 10px; list-style: none; padding-left: 0;">
                                    ${data.steps ? data.steps.map(s => `
                                        <li style="padding: 5px 0; border-bottom: 1px solid #c3e6cb;">
                                            <span style="color: #6c757d; font-size: 0.9em;">${s.timestamp}</span> - 
                                            <strong>${s.step}:</strong> 
                                            ${s.success ? 
                                                '<span style="color: #28a745;">✓</span>' : 
                                                '<span style="color: #dc3545;">✗</span>'} 
                                            ${s.message}
                                        </li>
                                    `).join('') : '<li>Nessun dettaglio disponibile</li>'}
                                </ul>
                            </details>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-danger">
                            <h5>❌ Test Downlink Fallito</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Errore:</strong> ${data.error || 'Errore sconosciuto'}</p>
                            ${data.steps && data.steps.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📋 Dettagli steps</summary>
                                    <ul style="margin-top: 10px; list-style: none; padding-left: 0;">
                                        ${data.steps.map(s => `
                                            <li style="padding: 5px 0; border-bottom: 1px solid #f5c6cb;">
                                                <span style="color: #6c757d; font-size: 0.9em;">${s.timestamp}</span> - 
                                                <strong>${s.step}:</strong> 
                                                ${s.success ? 
                                                    '<span style="color: #28a745;">✓</span>' : 
                                                    '<span style="color: #dc3545;">✗</span>'} 
                                                ${s.message}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function runMetricsTest() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;

            if (!deviceId || !numSensors) {
                alert('Inserisci Device ID e Numero Sensori');
                return;
            }

            // Chiedi il range temporale
            const timeRange = prompt('Controlla metriche degli ultimi X minuti:', '5');
            if (!timeRange) return;

            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>🔄 Test Metriche in Range in corso...</h5>
                    <div class="spinner"></div>
                    <p>Recupero metriche degli ultimi ${timeRange} minuti...</p>
                    <p>UI: ${uiLocation}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('num_sensors', numSensors);
            formData.append('time_range', timeRange);
            formData.append('ui_location', uiLocation);
            
            fetch('/test_metrics', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>✅ Test Metriche Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Metriche trovate:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Letture totali:</strong> ${data.total_readings || 'N/A'}</p>
                            <p><strong>Prima lettura:</strong> ${data.first_reading || 'N/A'}</p>
                            <p><strong>Ultima lettura:</strong> ${data.last_reading || 'N/A'}</p>
                            
                            ${data.metrics_by_category ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">🌤️ Stazione Meteo (${data.metrics_by_category.weather.found.length}/5)</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.metrics_by_category.weather.found.length > 0 ? 
                                            `<li><strong>Trovate:</strong><br>${data.metrics_by_category.weather.found.map(m => `• ${m}`).join('<br>')}</li>` : 
                                            '<li>Nessuna metrica trovata</li>'}
                                        ${data.metrics_by_category.weather.missing.length > 0 ? 
                                            `<li style="margin-top: 10px;"><strong>Mancanti:</strong><br>${data.metrics_by_category.weather.missing.map(m => `• ${m}`).join('<br>')}</li>` : ''}
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📦 Smart Junction Box (${data.metrics_by_category.junction_box.found.length}/5)</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.metrics_by_category.junction_box.found.length > 0 ? 
                                            `<li><strong>Trovate:</strong><br>${data.metrics_by_category.junction_box.found.map(m => `• ${m}`).join('<br>')}</li>` : 
                                            '<li>Nessuna metrica trovata</li>'}
                                        ${data.metrics_by_category.junction_box.missing.length > 0 ? 
                                            `<li style="margin-top: 10px;"><strong>Mancanti:</strong><br>${data.metrics_by_category.junction_box.missing.map(m => `• ${m}`).join('<br>')}</li>` : ''}
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">⚡ Sensori di Tiro (${data.metrics_by_category.load.found.length}/${numSensors == '3' ? 3 : numSensors == '6' ? 6 : 12})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.metrics_by_category.load.found.length > 0 ? 
                                            `<li><strong>Trovate:</strong><br>${data.metrics_by_category.load.found.map(m => `• ${m}`).join('<br>')}</li>` : 
                                            '<li>Nessuna metrica trovata</li>'}
                                        ${data.metrics_by_category.load.missing.length > 0 ? 
                                            `<li style="margin-top: 10px;"><strong>Mancanti:</strong><br>${data.metrics_by_category.load.missing.map(m => `• ${m}`).join('<br>')}</li>` : ''}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                    ${data.details.map(d => `
                                        <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: #dc3545;' : 'color: #28a745;'}">
                                            <span style="color: #6c757d;">${d.timestamp}</span> - ${d.message}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <h5>⚠️ Test Metriche - METRICHE MANCANTI</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Metriche trovate:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Metriche mancanti:</strong> ${data.missing_metrics ? data.missing_metrics.join(', ') : 'N/A'}</p>
                            
                            ${data.metrics_by_category ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">🌤️ Stazione Meteo</summary>
                                    <ul style="margin-top: 10px;">
                                        <li><strong>Trovate:</strong> ${data.metrics_by_category.weather.found.join(', ') || 'Nessuna'}</li>
                                        <li><strong>Mancanti:</strong> ${data.metrics_by_category.weather.missing.join(', ') || 'Nessuna'}</li>
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📦 Smart Junction Box</summary>
                                    <ul style="margin-top: 10px;">
                                        <li><strong>Trovate:</strong> ${data.metrics_by_category.junction_box.found.join(', ') || 'Nessuna'}</li>
                                        <li><strong>Mancanti:</strong> ${data.metrics_by_category.junction_box.missing.join(', ') || 'Nessuna'}</li>
                                    </ul>
                                </details>
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">⚡ Sensori di Tiro</summary>
                                    <ul style="margin-top: 10px;">
                                        <li><strong>Trovate:</strong> ${data.metrics_by_category.load.found.join(', ') || 'Nessuna'}</li>
                                        <li><strong>Mancanti:</strong> ${data.metrics_by_category.load.missing.join(', ') || 'Nessuna'}</li>
                                    </ul>
                                </details>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                    ${data.details ? data.details.map(d => `
                                        <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: red;' : ''}">
                                            ${d.timestamp} - ${d.message}
                                        </div>
                                    `).join('') : 'Nessun dettaglio'}
                                </div>
                            </details>
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function runAlarmTest() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;
        
            if (!deviceId || !numSensors || !uiLocation) {
                alert('Inserisci Device ID, Numero Sensori e UI');
                return;
            }
        
            // Mappatura per nomi friendly degli allarmi
            const alarmNames = {
                'EGM_OUT_SENS_23_VAR_32': 'TC_F12A_L1',
                'EGM_OUT_SENS_23_VAR_33': 'TC_F12A_L2',
                'EGM_OUT_SENS_23_VAR_34': 'TC_F12B_L1',
                'EGM_OUT_SENS_23_VAR_35': 'TC_F12B_L2',
                'EGM_OUT_SENS_23_VAR_36': 'TC_F4A_L1',
                'EGM_OUT_SENS_23_VAR_37': 'TC_F4A_L2',
                'EGM_OUT_SENS_23_VAR_38': 'TC_F4B_L1',
                'EGM_OUT_SENS_23_VAR_39': 'TC_F4B_L2',
                'EGM_OUT_SENS_23_VAR_40': 'TC_F8A_L1',
                'EGM_OUT_SENS_23_VAR_41': 'TC_F8A_L2',
                'EGM_OUT_SENS_23_VAR_42': 'TC_F8B_L1',
                'EGM_OUT_SENS_23_VAR_43': 'TC_F8B_L2',
                'EGM_OUT_SENS_23_VAR_30': 'Inc_X',
                'EGM_OUT_SENS_23_VAR_31': 'Inc_Y'
            };
        
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>🚨 Test Allarme Metriche in corso...</h5>
                    <div class="spinner"></div>
                    <p>Recupero ultimi allarmi disponibili...</p>
                    <p>UI: ${uiLocation}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('num_sensors', numSensors);
            formData.append('ui_location', uiLocation);
            
            fetch('/test_alarm', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())

            .then(data => {
                console.log('Dati ricevuti dal test allarmi:', data);
                
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>✅ Test Allarmi Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Allarmi trovati:</strong> ${data.total_found}/${data.total_expected}</p>
                            <br>
                            <p>Response</p>
                            
                            ${data.found_alarms && data.found_alarms.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">✅ Allarmi verificati (${data.found_alarms.length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.found_alarms.map(alarm => {
                                            const friendlyName = alarmNames[alarm] || alarm;
                                            const value = data.alarm_values ? data.alarm_values[alarm] : 'N/A';
                                            return `<li><strong>${alarm} - ${friendlyName}:</strong> ${value}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.other_alarms && Object.keys(data.other_alarms).length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">ℹ️ Altri allarmi trovati (${Object.keys(data.other_alarms).length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${Object.entries(data.other_alarms).map(([key, val]) => {
                                            const friendlyName = alarmNames[key] || key;
                                            return `<li><strong>${key} - ${friendlyName}:</strong> ${val}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.details && data.details.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                    <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                        ${data.details.map(d => `
                                            <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: #dc3545;' : 'color: #28a745;'}">
                                                <span style="color: #6c757d;">${d.timestamp}</span> - ${d.message}
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <h5>⚠️ Test Allarmi - ALLARMI MANCANTI</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Allarmi trovati:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Allarmi mancanti:</strong> ${data.missing_alarms ? 
                                data.missing_alarms.map(alarm => {
                                    const friendlyName = alarmNames[alarm] || alarm;
                                    return `${alarm} - ${friendlyName}`;
                                }).join(', ') : 
                                'N/A'}</p>
                            <br>
                            <p>Response</p>
                            
                            ${data.found_alarms && data.found_alarms.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">✅ Allarmi trovati (${data.found_alarms.length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${data.found_alarms.map(alarm => {
                                            const friendlyName = alarmNames[alarm] || alarm;
                                            const value = data.alarm_values ? data.alarm_values[alarm] : 'N/A';
                                            return `<li><strong>${alarm} - ${friendlyName}:</strong> ${value}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.other_alarms && Object.keys(data.other_alarms).length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">ℹ️ Altri allarmi trovati (${Object.keys(data.other_alarms).length})</summary>
                                    <ul style="margin-top: 10px;">
                                        ${Object.entries(data.other_alarms).map(([key, val]) => {
                                            const friendlyName = alarmNames[key] || key;
                                            return `<li><strong>${key} - ${friendlyName}:</strong> ${val}</li>`;
                                        }).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            
                            ${data.details && data.details.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">📋 Log completo del test</summary>
                                    <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                        ${data.details.map(d => `
                                            <div style="padding: 3px 0; font-size: 0.9em; ${!d.success ? 'color: #dc3545;' : 'color: #28a745;'}">
                                                <span style="color: #6c757d;">${d.timestamp}</span> - ${d.message}
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function openLiveMonitoring() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;

            if (!deviceId || !numSensors || !uiLocation) {
                alert('⚠️ Compilare prima i campi:\n\n• Device ID\n• Numero Sensori\n• UI Località');
                return;
            }

            // Apri pagina di monitoraggio con parametri
            const params = new URLSearchParams({
                device_id: deviceId,
                num_sensors: numSensors,
                ui: uiLocation,
                timeout: 120, // Timeout di 60 minuti
                mode: 'unified' // Indica modalità unificata per metriche + allarmi
            });

            window.open(`/monitoring?${params}`, '_blank');
        }

        // Auto-fill end date quando cambia start date
        document.getElementById('start_date').addEventListener('change', function() {
            const endDate = document.getElementById('end_date');
            if (!endDate.value) {
                endDate.value = this.value;
            }
        });

        // Auto-fill end time quando cambia start time  
        document.getElementById('start_time').addEventListener('change', function() {
            const endTime = document.getElementById('end_time');
            if (!endTime.value) {
                endTime.value = this.value;
            }
        });

        // Toggle email options
        document.getElementById('send_email').addEventListener('change', function() {
            const emailOptions = document.getElementById('email_options');
            emailOptions.style.display = this.checked ? 'block' : 'none';
        });
        
        // Toggle label per Downlink
        document.getElementById('enable_downlink').addEventListener('change', function() {
            const statusLabel = document.getElementById('downlink_status');
            if (this.checked) {
                statusLabel.textContent = 'Abilitato';
                statusLabel.style.color = '#28a745';
            } else {
                statusLabel.textContent = 'Disabilitato';
                statusLabel.style.color = '#dc3545';
            }
        });

        function validateDateTime() {
            const startDate = document.getElementById('start_date').value;
            const startTime = document.getElementById('start_time').value;
            const endDate = document.getElementById('end_date').value;
            const endTime = document.getElementById('end_time').value;
            
            // Controlla che tutti i campi siano compilati
            if (!startDate || !startTime || !endDate || !endTime) {
                return {
                    valid: false,
                    message: 'Compila tutti i campi di data e ora'
                };
            }
            
            // Crea oggetti Date per il confronto
            const startDateTime = new Date(`${startDate}T${startTime}:00`);
            const endDateTime = new Date(`${endDate}T${endTime}:00`);
            
            // Verifica che la data/ora di fine sia successiva a quella di inizio
            if (endDateTime <= startDateTime) {
                return {
                    valid: false,
                    message: 'La data/ora di fine deve essere successiva a quella di inizio'
                };
            }
            
            // Verifica che la durata non sia eccessiva (es. max 7 giorni)
            const diffHours = (endDateTime - startDateTime) / (1000 * 60 * 60);
            if (diffHours > 168) { // 7 giorni = 168 ore
                return {
                    valid: false,
                    message: 'La durata del test non può superare i 7 giorni'
                };
            }
            
            return {
                valid: true,
                message: 'Date valide'
            };
        }

        // Funzione per mostrare errori di validazione
        function showValidationError(message) {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = `
                <div class="alert alert-danger">
                    <h5>❌ Errore Validazione</h5>
                    <p>${message}</p>
                </div>
            `;
            testResults.style.display = 'block';
            
            // Scorri verso l'errore
            testResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showPreview() {
            // Validazione data/ora
            const validation = validateDateTime();
            if (!validation.valid) {
                showValidationError(validation.message);
                return;
            }
            
            const form = document.getElementById('reportForm');
            const formData = new FormData(form);
            
            const downlinkCheckbox = document.getElementById('enable_downlink');
            if (downlinkCheckbox) {
                formData.delete('enable_downlink');
                if (downlinkCheckbox.checked) {
                    formData.append('enable_downlink', 'on');
                }
            }
            
            const previewDiv = document.getElementById('preview');
            previewDiv.innerHTML = '<div class="alert alert-info"><span class="spinner"></span> Caricamento anteprima...</div>';
            previewDiv.style.display = 'block';
            
            fetch('/preview', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                previewDiv.innerHTML = html;
            })
            .catch(error => {
                previewDiv.innerHTML = '<div class="alert alert-danger">Errore nel caricamento dell\'anteprima</div>';
            });
        }

        // Validazione al submit del form
        document.addEventListener('DOMContentLoaded', function() {
            const reportForm = document.getElementById('reportForm');
            
            reportForm.addEventListener('submit', function(e) {
                console.log('Form submit intercepted for validation');
                
                // Validazione data/ora prima del submit
                const validation = validateDateTime();
                if (!validation.valid) {
                    console.log('Validation failed:', validation.message);
                    e.preventDefault(); // Impedisce il submit
                    showValidationError(validation.message);
                    return false;
                }
                
                console.log('Validation passed, allowing form submit');
            });
            
            // Validazione in tempo reale quando cambiano i campi
            const dateTimeFields = ['start_date', 'start_time', 'end_date', 'end_time'];
            dateTimeFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function() {
                        // Nascondi eventuali errori precedenti dopo 2 secondi
                        setTimeout(() => {
                            const testResults = document.getElementById('testResults');
                            if (testResults.style.display !== 'none') {
                                const alertDanger = testResults.querySelector('.alert-danger');
                                if (alertDanger && alertDanger.textContent.includes('Errore Validazione')) {
                                    testResults.style.display = 'none';
                                }
                            }
                        }, 2000);
                    });
                }
            });
        });
        document.getElementById('enable_allarme').addEventListener('change', function() {
            const statusLabel = document.getElementById('allarme_status');
            if (this.checked) {
                statusLabel.textContent = 'Abilitato';
                statusLabel.style.color = '#28a745';
            } else {
                statusLabel.textContent = 'Disabilitato';
                statusLabel.style.color = '#dc3545';
            }
        });
        // Funzione per determinare il vendor dal Device ID
        function detectVendorFromDeviceId(deviceId) {
            // Pattern per identificare il tipo di dispositivo
            // Formato: 1:1:2:XX:YY:DIGIL_ZZZ_NNNN
            
            if (!deviceId || !deviceId.includes('DIGIL_')) {
                return null;
            }
            
            // Estrai la parte centrale (ZZZ) dopo DIGIL_
            const match = deviceId.match(/DIGIL_([A-Z0-9]+)_/);
            
            if (match && match[1]) {
                const deviceType = match[1];
                
                // Mappatura tipo dispositivo -> vendor
                const vendorMapping = {
                    'IND': 'Indra/Olivetti',
                    'SR2': 'Sirtiv2',
                    'MRN': 'MII',
                    'MII': 'MII'  // Aggiunto per sicurezza se ci fossero altri pattern
                };
                
                // Controlla se il tipo dispositivo corrisponde a uno dei vendor
                for (const [prefix, vendor] of Object.entries(vendorMapping)) {
                    if (deviceType.startsWith(prefix) || deviceType === prefix) {
                        return vendor;
                    }
                }
            }
            
            return null;
        }

        // Aggiungi event listener per il campo Device ID
        document.addEventListener('DOMContentLoaded', function() {
            const deviceIdField = document.getElementById('device_id');
            const vendorField = document.getElementById('vendor');
            
            // Flag per tracciare se l'utente ha modificato manualmente il vendor
            let vendorManuallyChanged = false;
            
            // Rileva quando l'utente modifica manualmente il vendor
            vendorField.addEventListener('change', function(e) {
                // Se il change event non è stato triggerato dal codice (dall'auto-detect)
                if (!e.isTrusted) return;
                vendorManuallyChanged = true;
            });           
            // Auto-detect vendor quando viene inserito/modificato il Device ID
            deviceIdField.addEventListener('input', function() {
                const deviceId = this.value.trim();
                
                // Se l'utente ha già modificato manualmente il vendor, non sovrascrivere
                // a meno che il campo vendor non sia vuoto
                if (vendorManuallyChanged && vendorField.value) {
                    return;
                }
                
                // Prova a rilevare il vendor
                const detectedVendor = detectVendorFromDeviceId(deviceId);
                
                if (detectedVendor) {
                    // Imposta il vendor rilevato
                    vendorField.value = detectedVendor;
                    
                    // Mostra un feedback visivo temporaneo
                    vendorField.style.backgroundColor = '#d4edda';
                    vendorField.style.transition = 'background-color 0.3s';
                    
                    setTimeout(() => {
                        vendorField.style.backgroundColor = '';
                    }, 1000);
                    
                    console.log(`Vendor auto-rilevato: ${detectedVendor} per device ${deviceId}`);
                }
            });
            
            // Reset del flag quando il form viene resettato
            const reportForm = document.getElementById('reportForm');
            reportForm.addEventListener('reset', function() {
                vendorManuallyChanged = false;
            });
            
            // Se il Device ID è già compilato al caricamento della pagina, prova il rilevamento
            if (deviceIdField.value) {
                const detectedVendor = detectVendorFromDeviceId(deviceIdField.value);
                if (detectedVendor && !vendorField.value) {
                    vendorField.value = detectedVendor;
                }
            }
        });
        let anagraficaData = null;
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona prima un file CSV');
                return;
            }
            
            // Verifica nome file (opzionale, può essere rimosso se non necessario)
            if (!file.name.includes('digil_anagrafica')) {
                if (!confirm('Il file non sembra essere "digil_anagrafica_data_result.csv". Vuoi continuare comunque?')) {
                    return;
                }
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    anagraficaData = parseCSV(csvText);
                    
                    if (anagraficaData && Object.keys(anagraficaData).length > 0) {
                        // Salva in localStorage per persistenza
                        localStorage.setItem('digil_anagrafica', JSON.stringify(anagraficaData));
                        localStorage.setItem('digil_anagrafica_date', new Date().toISOString());
                        
                        updateAnagraficaStatus(true);
                        
                        // Se c'è già un Device ID inserito, prova a compilare i campi
                        const deviceId = document.getElementById('device_id').value;
                        if (deviceId) {
                            autoFillFromAnagrafica(deviceId);
                        }
                    } else {
                        alert('Il file CSV sembra essere vuoto o non valido');
                    }
                } catch (error) {
                    alert('Errore nel parsing del CSV: ' + error.message);
                    console.error('Errore parsing CSV:', error);
                }
            };
            
            reader.readAsText(file);
        }

        // Parser CSV robusto che gestisce campi con virgole
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return null;
            
            // Funzione helper per parsare una riga CSV gestendo virgole dentro virgolette
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            
            // Estrai headers
            const headers = parseCSVLine(lines[0]);
            
            // Trova gli indici delle colonne che ci interessano (case-insensitive)
            const deviceIdIndex = headers.findIndex(h => h.toLowerCase() === 'deviceid');
            const uiIndex = headers.findIndex(h => h.toLowerCase() === 'ui');
            const nSensoriIndex = headers.findIndex(h => h.toLowerCase() === 'n_sensori');
            const vendorIndex = headers.findIndex(h => h.toLowerCase() === 'vendor');
            
            console.log('Indici colonne trovati:', {
                deviceId: deviceIdIndex,
                ui: uiIndex,
                nSensori: nSensoriIndex,
                vendor: vendorIndex
            });
            
            if (deviceIdIndex === -1) {
                alert('Colonna DeviceID non trovata nel CSV');
                return null;
            }
            
            // Parse dei dati
            const data = {};
            const uniqueDevices = new Set();
            let errorCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = parseCSVLine(lines[i]);
                    
                    // Verifica che ci siano abbastanza colonne
                    if (values.length <= Math.max(deviceIdIndex, uiIndex, nSensoriIndex, vendorIndex)) {
                        continue;
                    }
                    
                    const deviceId = values[deviceIdIndex];
                    
                    // Salta righe vuote o device già processati
                    if (!deviceId || deviceId === '' || uniqueDevices.has(deviceId)) {
                        continue;
                    }
                    
                    uniqueDevices.add(deviceId);
                    
                    // Estrai i valori con controlli di sicurezza
                    const deviceData = {
                        deviceId: deviceId,
                        ui: uiIndex !== -1 && values[uiIndex] ? values[uiIndex] : null,
                        nSensori: nSensoriIndex !== -1 && values[nSensoriIndex] ? values[nSensoriIndex] : null,
                        vendor: vendorIndex !== -1 && values[vendorIndex] ? values[vendorIndex] : null
                    };
                    
                    // Salva solo se ha almeno un dato oltre al deviceId
                    if (deviceData.ui || deviceData.nSensori || deviceData.vendor) {
                        data[deviceId] = deviceData;
                    }
                    
                } catch (e) {
                    errorCount++;
                    console.warn(`Errore parsing riga ${i}:`, e);
                }
            }
            
            console.log(`Anagrafica caricata: ${Object.keys(data).length} dispositivi validi su ${uniqueDevices.size} unici`);
            if (errorCount > 0) {
                console.warn(`${errorCount} righe con errori ignorate`);
            }
            
            return Object.keys(data).length > 0 ? data : null;
        }

        // Funzione per auto-compilare i campi
        function autoFillFromAnagrafica(deviceId) {
            if (!anagraficaData || !deviceId) return;
            
            // Cerca il dispositivo nell'anagrafica
            const deviceInfo = anagraficaData[deviceId];
            
            if (deviceInfo) {
                console.log('Dispositivo trovato nell\'anagrafica:', deviceInfo);
                
                // Compila Numero Sensori
                if (deviceInfo.nSensori) {
                    const numSensorsField = document.getElementById('num_sensors');
                    const nSensori = parseInt(deviceInfo.nSensori);
                    
                    // Mappa ai valori del select (3, 6, 12)
                    if ([3, 6, 12].includes(nSensori)) {
                        numSensorsField.value = nSensori.toString();
                        highlightField(numSensorsField);
                    }
                }
                
                // Compila UI Località
                if (deviceInfo.ui) {
                    const uiField = document.getElementById('ui_location');
                    // Cerca un match esatto o parziale nelle opzioni
                    const options = Array.from(uiField.options);
                    const exactMatch = options.find(opt => opt.value === deviceInfo.ui);
                    
                    if (exactMatch) {
                        uiField.value = deviceInfo.ui;
                        highlightField(uiField);
                    } else {
                        // Prova un match parziale
                        const partialMatch = options.find(opt => 
                            opt.value.toLowerCase().includes(deviceInfo.ui.toLowerCase()) ||
                            deviceInfo.ui.toLowerCase().includes(opt.value.toLowerCase())
                        );
                        if (partialMatch) {
                            uiField.value = partialMatch.value;
                            highlightField(uiField);
                        }
                    }
                }
                
                // Se c'è anche il vendor nell'anagrafica e il campo è vuoto, compilalo
                if (deviceInfo.vendor && !document.getElementById('vendor').value) {
                    const vendorField = document.getElementById('vendor');
                    // Prova prima il mapping standard
                    const mappedVendor = mapVendorName(deviceInfo.vendor);
                    if (mappedVendor && Array.from(vendorField.options).some(opt => opt.value === mappedVendor)) {
                        vendorField.value = mappedVendor;
                        highlightField(vendorField);
                    }
                }
                
                return true;
            } else {
                console.log('Dispositivo non trovato nell\'anagrafica:', deviceId);
                return false;
            }
        }

        // Mappa i nomi vendor dal CSV alle opzioni del select
        function mapVendorName(csvVendor) {
            const vendorMap = {
                'IBM': 'MII',
                'MII': 'MII',
                'INDRA': 'Indra/Olivetti',
                'OLIVETTI': 'Indra/Olivetti',
                'SIRTIV2': 'Sirtiv2',
                'SIRTI': 'Sirtiv2'
            };
            
            const upper = csvVendor.toUpperCase();
            return vendorMap[upper] || null;
        }

        // Evidenzia un campo quando viene auto-compilato
        function highlightField(field) {
            field.style.backgroundColor = '#d4edda';
            field.style.transition = 'background-color 0.3s';
            
            setTimeout(() => {
                field.style.backgroundColor = '';
            }, 1500);
        }

        // Aggiorna lo stato dell'anagrafica nell'interfaccia
        function updateAnagraficaStatus(loaded) {
            const statusSpan = document.getElementById('csvStatus');
            const statsDiv = document.getElementById('anagraficaStats');
            const statsInfo = document.getElementById('statsInfo');
            
            if (loaded && anagraficaData) {
                const deviceCount = Object.keys(anagraficaData).length;
                const loadDate = localStorage.getItem('digil_anagrafica_date');
                const dateStr = loadDate ? new Date(loadDate).toLocaleString('it-IT') : 'ora';
                
                statusSpan.textContent = `✅ Anagrafica caricata (${deviceCount} dispositivi)`;
                statusSpan.style.color = '#28a745';
                
                statsInfo.textContent = `Totale dispositivi: ${deviceCount} | Caricata: ${dateStr}`;
                statsDiv.style.display = 'block';
            } else {
                statusSpan.textContent = 'Nessuna anagrafica caricata';
                statusSpan.style.color = '#6c757d';
                statsDiv.style.display = 'none';
            }
        }

        // Cancella l'anagrafica dalla memoria
        function clearAnagrafica() {
            if (confirm('Sei sicuro di voler cancellare l\'anagrafica caricata?')) {
                anagraficaData = null;
                localStorage.removeItem('digil_anagrafica');
                localStorage.removeItem('digil_anagrafica_date');
                document.getElementById('csvFile').value = '';
                updateAnagraficaStatus(false);
            }
        }

        // Al caricamento della pagina, verifica se c'è un'anagrafica salvata
        document.addEventListener('DOMContentLoaded', function() {
            // Carica anagrafica da localStorage se presente
            const savedAnagrafica = localStorage.getItem('digil_anagrafica');
            if (savedAnagrafica) {
                try {
                    anagraficaData = JSON.parse(savedAnagrafica);
                    updateAnagraficaStatus(true);
                    console.log('Anagrafica caricata da cache locale');
                } catch (e) {
                    console.error('Errore caricamento anagrafica da cache:', e);
                }
            }
            
            // Aggiungi listener al campo Device ID per auto-compilazione
            const deviceIdField = document.getElementById('device_id');
            const originalListener = deviceIdField.oninput;
            
            deviceIdField.addEventListener('input', function() {
                const deviceId = this.value.trim();
                
                // Esegui prima la logica originale del vendor (se esiste)
                if (originalListener) originalListener.call(this);
                
                // Poi prova a compilare dall'anagrafica
                if (anagraficaData && deviceId) {
                    autoFillFromAnagrafica(deviceId);
                }
            });
        });

        // Opzione per caricare automaticamente un CSV predefinito dal server (se disponibile)
        function loadDefaultAnagrafica() {
            fetch('/static/digil_anagrafica_data_result.csv')
                .then(response => {
                    if (response.ok) return response.text();
                    throw new Error('File non trovato');
                })
                .then(csvText => {
                    anagraficaData = parseCSV(csvText);
                    if (anagraficaData) {
                        localStorage.setItem('digil_anagrafica', JSON.stringify(anagraficaData));
                        localStorage.setItem('digil_anagrafica_date', new Date().toISOString());
                        updateAnagraficaStatus(true);
                    }
                })
                .catch(error => {
                    console.log('Anagrafica predefinita non disponibile:', error);
                });
        }

        function toggleAnagrafica() {
            const section = document.getElementById('anagraficaSection');
            const button = document.getElementById('toggleAnagraficaBtn');
            
            if (section.style.display === 'none' || section.style.display === '') {
                // Apri la sezione
                section.style.display = 'block';
                button.innerHTML = '📂 Gestione Anagrafica ▲';
                
                // Se c'è un'anagrafica caricata, mostra il badge
                if (anagraficaData && Object.keys(anagraficaData).length > 0) {
                    const count = Object.keys(anagraficaData).length;
                    button.innerHTML = `📂 Gestione Anagrafica (${count} dispositivi) ▲`;
                }
            } else {
                // Chiudi la sezione con animazione
                section.classList.add('closing');
                
                setTimeout(() => {
                    section.style.display = 'none';
                    section.classList.remove('closing');
                    
                    // Aggiorna il testo del bottone
                    if (anagraficaData && Object.keys(anagraficaData).length > 0) {
                        const count = Object.keys(anagraficaData).length;
                        button.innerHTML = `📂 Gestione Anagrafica (${count} dispositivi) ▼`;
                    } else {
                        button.innerHTML = '📂 Gestione Anagrafica ▼';
                    }
                }, 300);
            }
        }

        // Modifica la funzione updateAnagraficaStatus per aggiornare anche il bottone
        function updateAnagraficaStatus(loaded) {
            const statusSpan = document.getElementById('csvStatus');
            const statsDiv = document.getElementById('anagraficaStats');
            const statsInfo = document.getElementById('statsInfo');
            const toggleBtn = document.getElementById('toggleAnagraficaBtn');
            
            if (loaded && anagraficaData) {
                const deviceCount = Object.keys(anagraficaData).length;
                const loadDate = localStorage.getItem('digil_anagrafica_date');
                const dateStr = loadDate ? new Date(loadDate).toLocaleString('it-IT') : 'ora';
                
                statusSpan.textContent = `✅ Anagrafica caricata (${deviceCount} dispositivi)`;
                statusSpan.style.color = '#28a745';
                
                statsInfo.textContent = `Totale dispositivi: ${deviceCount} | Caricata: ${dateStr}`;
                statsDiv.style.display = 'block';
                
                // Aggiorna il bottone toggle con il conteggio
                const isOpen = document.getElementById('anagraficaSection').style.display !== 'none';
                toggleBtn.innerHTML = `📂 Gestione Anagrafica (${deviceCount} dispositivi) ${isOpen ? '▲' : '▼'}`;
            } else {
                statusSpan.textContent = 'Nessuna anagrafica caricata';
                statusSpan.style.color = '#6c757d';
                statsDiv.style.display = 'none';
                
                // Reset del bottone toggle
                const isOpen = document.getElementById('anagraficaSection').style.display !== 'none';
                toggleBtn.innerHTML = `📂 Gestione Anagrafica ${isOpen ? '▲' : '▼'}`;
            }
        }
    </script>
</body>
</html>