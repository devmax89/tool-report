<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIL Report Generator - Terna</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-container">
        <div class="app-header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='logo/terna_logo.png') }}" alt="Terna Logo">
                </div>
                <div class="header-text">
                    <h1>DIGIL Report Generator</h1>
                    <p>Sistema di generazione report per dispositivi DIGIL</p>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <form id="reportForm" method="POST">
                <div class="form-grid">
                    <!-- Sezione Configurazione Device -->
                    <div class="form-section">
                        <h3>üì° Configurazione Device</h3>
                        
                        <div class="form-group">
                            <label for="num_sensors">Numero Sensori *</label>
                            <select class="form-select" id="num_sensors" name="num_sensors" required>
                                <option value="">Seleziona...</option>
                                <option value="3">3 Sensori</option>
                                <option value="6">6 Sensori</option>
                                <option value="12">12 Sensori</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="vendor">Vendor *</label>
                            <select class="form-select" id="vendor" name="vendor" required>
                                <option value="">Seleziona...</option>
                                <option value="MII">MII</option>
                                <option value="Indra/Olivetti">Indra/Olivetti</option>
                                <option value="Sirtiv2">Sirtiv2</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="device_id">Device ID *</label>
                            <input type="text" class="form-control" id="device_id" name="device_id" 
                                   placeholder="es. 1:1:2:16:22:DIGIL_MRN_0299" required>
                            <div class="form-text">Formato: 1:1:2:16:22:DIGIL_XXX_YYYY</div>
                        </div>
                    </div>
                    
                    <!-- Sezione Periodo Test -->
                    <div class="form-section">
                        <h3>üìÖ Periodo Test</h3>
                        
                        <div class="form-group">
                            <label>Data e Ora Inizio *</label>
                            <div class="datetime-grid">
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                <input type="time" class="form-control" id="start_time" name="start_time" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Data e Ora Fine *</label>
                            <div class="datetime-grid">
                                <input type="date" class="form-control" id="end_date" name="end_date" required>
                                <input type="time" class="form-control" id="end_time" name="end_time" required>
                            </div>
                        </div>
                        
                        <div class="form-text">
                            * La data di fine viene auto-compilata quando inserisci la data di inizio
                        </div>
                    </div>

                    <!-- Sezione Opzioni Invio -->
                    <div class="form-section">
                        <h3>üìß Opzioni Invio Email</h3>

                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="send_email" name="send_email" style="width: auto;">
                                <label for="send_email" style="margin: 0; cursor: pointer;">
                                    Invia report via email dopo la generazione
                                </label>
                            </div>
                        </div>

                        <div id="email_options" style="display: none;">
                            <div class="alert alert-info" style="margin: 15px 0;">
                                <small>Il report verr√† inviato agli indirizzi configurati per il vendor selezionato.</small>
                            </div>

                            <div class="form-group">
                                <label for="custom_email">Email personalizzata (opzionale)</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="custom_email" 
                                       name="custom_email" 
                                       placeholder="Lascia vuoto per usare gli indirizzi predefiniti">
                                <div class="form-text">
                                    Se specificata, il report verr√† inviato SOLO a questa email
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ui_location">UI Localit√† *</label>
                        <select class="form-select" id="ui_location" name="ui_location" required>
                            <option value="">Seleziona...</option>
                            <option value="Abruzzo Molise">Abruzzo Molise</option>
                            <option value="Bari">Bari</option>
                            <option value="Bologna">Bologna</option>
                            <option value="Brescia">Brescia</option>
                            <option value="Brindisi">Brindisi</option>
                            <option value="Brugherio">Brugherio</option>
                            <option value="Catania">Catania</option>
                            <option value="Chiuro">Chiuro</option>
                            <option value="Cislago">Cislago</option>
                            <option value="Codrongianos">Codrongianos</option>
                            <option value="Dugale">Dugale</option>
                            <option value="Feroleto">Feroleto</option>
                            <option value="Firenze">Firenze</option>
                            <option value="Frattamaggiore">Frattamaggiore</option>
                            <option value="Friuli Venezia Giulia">Friuli Venezia Giulia</option>
                            <option value="Genova">Genova</option>
                            <option value="Imola">Imola</option>
                            <option value="Lazio">Lazio</option>
                            <option value="Lazio Centro Sud">Lazio Centro Sud</option>
                            <option value="Lazio Nord">Lazio Nord</option>
                            <option value="Maddaloni">Maddaloni</option>
                            <option value="Marche">Marche</option>
                            <option value="Novara">Novara</option>
                            <option value="Palermo">Palermo</option>
                            <option value="Parma">Parma</option>
                            <option value="Pont Saint Martin">Pont Saint Martin</option>
                            <option value="Rotonda">Rotonda</option>
                            <option value="Sivizzano">Sivizzano</option>
                            <option value="Torino">Torino</option>
                            <option value="Trentino Alto Adige">Trentino Alto Adige</option>
                            <option value="Villasor">Villasor</option>
                            <option value="Vittorio Veneto">Vittorio Veneto</option>
                        </select>
                        <div class="form-text">Seleziona l'UI dove si trova il dispositivo (necessaria per test metriche)</div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="button-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 30px;">
            <!-- Prima riga: Test -->
            <button type="button" class="btn btn-info" onclick="runDownlinkTest()">
                üß™ Test Downlink
            </button>
            <button type="button" class="btn btn-success" onclick="runMetricsTest()">
                üìä Test Metriche
            </button>
            <button type="button" class="btn btn-danger" onclick="runAlarmTest()">
                üö® Test Allarmi
            </button>

            <!-- Seconda riga: Azioni principali -->
            <button type="button" class="btn btn-secondary" onclick="showPreview()">
                üëÅÔ∏è Anteprima Report
            </button>
            <button type="submit" form="reportForm" class="btn btn-primary" formaction="/generate">
                üíæ Genera e Salva Report
            </button>
            <a href="/reset" class="btn btn-warning" style="display: flex; align-items: center; justify-content: center;">
                üîÑ Reset Dispositivo
            </a>
        </div>
        
        <!-- Area risultati test -->
        <div id="testResults" style="display:none; margin: 20px 40px;">
            <!-- I risultati del test verranno mostrati qui -->
        </div>
        
        <div id="preview" style="display:none;">
            <!-- Preview content will be loaded here -->
        </div>
        
        <div class="footer">
            <p>DIGIL Report Generator v1.0</p>
        </div>
    </div>

    <script>
        function showPreview() {
            const form = document.getElementById('reportForm');
            const formData = new FormData(form);
            
            // Mostra loading
            const previewDiv = document.getElementById('preview');
            previewDiv.innerHTML = '<div class="alert alert-info"><span class="spinner"></span> Caricamento anteprima...</div>';
            previewDiv.style.display = 'block';
            
            fetch('/preview', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                previewDiv.innerHTML = html;
            })
            .catch(error => {
                previewDiv.innerHTML = '<div class="alert alert-danger">Errore nel caricamento dell\'anteprima</div>';
            });
        }
        
        function runDownlinkTest() {
            const deviceId = document.getElementById('device_id').value;
            
            if (!deviceId) {
                alert('Inserisci prima il Device ID');
                return;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>üîÑ Test Downlink in corso...</h5>
                    <div class="spinner"></div>
                    <p>Attendere, il test richiede circa 20-30 secondi</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            
            fetch('/test_downlink', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>‚úÖ Test Downlink Completato</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Durata:</strong> ${data.duration ? data.duration.toFixed(1) : 'N/A'} secondi</p>
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer; color: #155724;">Mostra dettagli steps</summary>
                                <ul style="margin-top: 10px; list-style: none; padding-left: 0;">
                                    ${data.steps ? data.steps.map(s => `
                                        <li style="padding: 5px 0; border-bottom: 1px solid #c3e6cb;">
                                            <span style="color: #6c757d; font-size: 0.9em;">${s.timestamp}</span> - 
                                            <strong>${s.step}:</strong> 
                                            ${s.success ? 
                                                '<span style="color: #28a745;">‚úì</span>' : 
                                                '<span style="color: #dc3545;">‚úó</span>'} 
                                            ${s.message}
                                        </li>
                                    `).join('') : '<li>Nessun dettaglio disponibile</li>'}
                                </ul>
                            </details>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-danger">
                            <h5>‚ùå Test Downlink Fallito</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Errore:</strong> ${data.error || 'Errore sconosciuto'}</p>
                            ${data.steps && data.steps.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #721c24;">Mostra dettagli steps</summary>
                                    <ul style="margin-top: 10px; list-style: none; padding-left: 0;">
                                        ${data.steps.map(s => `
                                            <li style="padding: 5px 0; border-bottom: 1px solid #f5c6cb;">
                                                <span style="color: #6c757d; font-size: 0.9em;">${s.timestamp}</span> - 
                                                <strong>${s.step}:</strong> 
                                                ${s.success ? 
                                                    '<span style="color: #28a745;">‚úì</span>' : 
                                                    '<span style="color: #dc3545;">‚úó</span>'} 
                                                ${s.message}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }

        function runMetricsTest() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;
                
            if (!deviceId || !numSensors) {
                alert('Inserisci Device ID e Numero Sensori');
                return;
            }
            
            // Chiedi il range temporale
            const timeRange = prompt('Controlla metriche degli ultimi X minuti:', '5');
            if (!timeRange) return;
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>üîÑ Test Metriche in Range in corso...</h5>
                    <div class="spinner"></div>
                    <p>Recupero metriche degli ultimi ${timeRange} minuti...</p>
                    <p>UI: ${uiLocation}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('num_sensors', numSensors);
            formData.append('time_range', timeRange);
            formData.append('ui_location', uiLocation);
            
            fetch('/test_metrics', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>‚úÖ Test Metriche Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Metriche trovate:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Letture totali:</strong> ${data.total_readings || 'N/A'}</p>
                            <p><strong>Prima lettura:</strong> ${data.first_reading || 'N/A'}</p>
                            <p><strong>Ultima lettura:</strong> ${data.last_reading || 'N/A'}</p>
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">Dettagli metriche</summary>
                                <div style="margin-top: 10px;">
                                    ${data.details.map(d => `
                                        <div style="padding: 3px 0; ${!d.success ? 'color: red;' : ''}">
                                            ${d.timestamp} - ${d.message}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <h5>‚ö†Ô∏è Test Metriche - METRICHE MANCANTI</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Metriche trovate:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Metriche mancanti:</strong> ${data.missing_metrics ? data.missing_metrics.join(', ') : 'N/A'}</p>
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer;">Dettagli completi</summary>
                                <div style="margin-top: 10px;">
                                    ${data.details ? data.details.map(d => `
                                        <div style="padding: 3px 0; ${!d.success ? 'color: red;' : ''}">
                                            ${d.timestamp} - ${d.message}
                                        </div>
                                    `).join('') : 'Nessun dettaglio'}
                                </div>
                            </details>
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }
        
        // Auto-fill end date quando cambia start date
        document.getElementById('start_date').addEventListener('change', function() {
            const endDate = document.getElementById('end_date');
            if (!endDate.value) {
                endDate.value = this.value;
            }
        });

        // Toggle email options
        document.getElementById('send_email').addEventListener('change', function() {
            const emailOptions = document.getElementById('email_options');
            emailOptions.style.display = this.checked ? 'block' : 'none';
        });

        function runAlarmTest() {
            const deviceId = document.getElementById('device_id').value;
            const numSensors = document.getElementById('num_sensors').value;
            const uiLocation = document.getElementById('ui_location').value;
            
            if (!deviceId || !numSensors || !uiLocation) {
                alert('Inserisci Device ID, Numero Sensori e UI');
                return;
            }
            
            // Chiedi il range temporale (default 60 minuti per allarmi)
            const timeRange = prompt('Controlla allarmi degli ultimi X minuti:', '60');
            if (!timeRange) return;
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>üö® Test Allarme Metriche in corso...</h5>
                    <div class="spinner"></div>
                    <p>Recupero allarmi degli ultimi ${timeRange} minuti...</p>
                    <p>UI: ${uiLocation}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('num_sensors', numSensors);
            formData.append('ui_location', uiLocation);
            formData.append('time_range', timeRange);  // Aggiungi range temporale
            
            fetch('/test_alarm', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <h5>‚úÖ Test Allarmi Completato - SUPERATO</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Allarmi trovati:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Range temporale:</strong> Ultimi ${timeRange} minuti</p>
                            ${data.alarm_values && Object.keys(data.alarm_values).length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer;">Valori allarmi rilevati</summary>
                                    <ul style="margin-top: 10px;">
                                        ${Object.entries(data.alarm_values).map(([key, val]) => 
                                            `<li><strong>${key}:</strong> ${val}</li>`
                                        ).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <h5>‚ö†Ô∏è Test Allarmi - ALLARMI MANCANTI</h5>
                            <p><strong>Device:</strong> ${deviceId}</p>
                            <p><strong>Allarmi trovati:</strong> ${data.total_found}/${data.total_expected}</p>
                            <p><strong>Allarmi mancanti:</strong> ${data.missing_alarms ? data.missing_alarms.join(', ') : 'N/A'}</p>
                            <p><strong>Range temporale:</strong> Ultimi ${timeRange} minuti</p>
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Errore Test</h5>
                        <p>${error}</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>